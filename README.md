# üöÄ MarsSeg API ‚Äî –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –ú–∞—Ä—Å–∞

–î–µ–º–æ-—Å–µ—Ä–≤–∏—Å –¥–ª—è **—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –º–∞—Ä—Å–∏–∞–Ω—Å–∫–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏** –Ω–∞ –±–∞–∑–µ **DeepLabV3 (MobileNetV2)**, –æ–±—É—á–µ–Ω–Ω–æ–π –Ω–∞ –¥–∞—Ç–∞—Å–µ—Ç–µ **AI4Mars**.  
–°–µ—Ä–≤–∏—Å –æ–±—ë—Ä–Ω—É—Ç –≤–æ **FastAPI** –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω –≤ **Docker** ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

> –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –ú–∞—Ä—Å–∞ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ **–º–∞—Å–∫—É** –∫–ª–∞—Å—Å–æ–≤ –∏ **–æ–≤–µ—Ä–ª–µ–π** –ø–æ–≤–µ—Ä—Ö –∏—Å—Ö–æ–¥–Ω–∏–∫–∞.

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚ö° REST API –Ω–∞ **FastAPI** + **Swagger UI** (`/docs`).
- üñºÔ∏è Toy-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/toy`: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Üí –æ—Ä–∏–≥–∏–Ω–∞–ª, –º–∞—Å–∫–∞, –æ–≤–µ—Ä–ª–µ–π.
- üß™ –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥: resize 256√ó256, **CLAHE**, —è—Ä–∫–æ—Å—Ç—å/–∫–æ–Ω—Ç—Ä–∞—Å—Ç (alpha/beta).
- üé® –õ–µ–≥–µ–Ω–¥–∞ –∫–ª–∞—Å—Å–æ–≤: `Soil`, `Bedrock`, `Sand`, `Big Rock`.
- üßπ –ê–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ‚Äî —Å—Ç–∞—Ä—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è).
- üê≥ **Docker** (CPU-—Å–±–æ—Ä–∫–∞): –±—ã—Å—Ç—Ä—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –±–∏–ª–¥—ã —Å –∫—ç—à–µ–º.

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
marsseg-api/
‚îÇ‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py           # —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã + toy-—Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ inference.py      # –∏–Ω—Ñ–µ—Ä–µ–Ω—Å (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è dict/—Ç–µ–Ω–∑–æ—Ä–∞)
‚îÇ   ‚îú‚îÄ‚îÄ preprocessing.py  # CLAHE, alpha/beta, resize/normalize
‚îÇ   ‚îú‚îÄ‚îÄ loader.py         # –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∏ –≤–µ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ model_def.py      # DeepLabV3 + MobileNetV2 (–∫–∞—Å—Ç–æ–º)
‚îÇ   ‚îú‚îÄ‚îÄ colormap.py       # —Ü–≤–µ—Ç–∞ –∫–ª–∞—Å—Å–æ–≤, –ª–µ–≥–µ–Ω–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ settings.py       # –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (pydantic-settings, .env)
‚îÇ‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep          # –ø–æ–ª–æ–∂–∏—Ç–µ —Å—é–¥–∞ `deeplabv3.pth`
‚îÇ‚îÄ‚îÄ artifacts/            # —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è git)
‚îÇ‚îÄ‚îÄ requirements.txt
‚îÇ‚îÄ‚îÄ Dockerfile
‚îÇ‚îÄ‚îÄ .env.example
‚îÇ‚îÄ‚îÄ README.md
```

---

## ‚ö†Ô∏è –í–µ—Å–∞ –º–æ–¥–µ–ª–∏

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π **–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç** –±–∏–Ω–∞—Ä–Ω—ã–µ –≤–µ—Å–∞, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä.  
–°–∫–∞—á–∞–π—Ç–µ `deeplabv3.pth` –ø–æ —Å—Å—ã–ª–∫–µ https://huggingface.co/1Lev/marsseg-deeplabv3/resolve/main/deeplabv3.pth –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ –ø–∞–ø–∫—É `models/`.

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `.env`

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ:
```bash
cp .env.example .env
```

–ü—Ä–∏–º–µ—Ä (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å `settings.py`):
```env
MARSSEG_MODEL_NAME=deeplabv3
MARSSEG_MODEL_WEIGHTS=models/deeplabv3.pth
MARSSEG_NUM_CLASSES=4
MARSSEG_CLASS_LABELS=["soil","bedrock","sand","big_rock"]
MARSSEG_RESIZE_TO=256
MARSSEG_CLAHE_CLIP_LIMIT=2.0
MARSSEG_CLAHE_TILE_GRID=8
MARSSEG_ALPHA=1.5
MARSSEG_BETA=50
MARSSEG_USE_MEAN_STD=False
MARSSEG_OVERLAY_ALPHA=0.5
# MARSSEG_WEIGHTS_URL=  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: URL –¥–ª—è –∞–≤—Ç–æ—Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–µ—Å–æ–≤
```

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ Docker)

1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
python -m venv venv
# Linux/Mac:
source venv/bin/activate
# Windows:
venv\Scripts\activate

pip install -r requirements.txt
```

2) –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `models/deeplabv3.pth` –ª–µ–∂–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ.

3) –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
uvicorn app.main:app --reload --port 8000
```

–û—Ç–∫—Ä–æ–π—Ç–µ:
- Toy-—Å—Ç—Ä–∞–Ω–∏—Ü–∞: http://127.0.0.1:8000/toy  
- Swagger UI: http://127.0.0.1:8000/docs  
- Health: http://127.0.0.1:8000/health

---

## üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker (CPU)

1) –°–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑:
```bash
docker build -t marsseg-api:0.1.0 .
```

2) –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–∞—Ä–∏–∞–Ω—Ç A: –≤–µ—Å–∞ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∞):
```bash
docker run --rm -p 8000:8000 --env-file .env marsseg-api:0.1.0
```

–∏–ª–∏ (–≤–∞—Ä–∏–∞–Ω—Ç B: –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫—É —Å –≤–µ—Å–∞–º–∏ —Ç–æ–º–æ–º):
```bash
# Windows PowerShell:
docker run --rm -p 8000:8000 --env-file .env -v ${PWD}/models:/app/models marsseg-api:0.1.0
# Linux/Mac:
docker run --rm -p 8000:8000 --env-file .env -v $(pwd)/models:/app/models marsseg-api:0.1.0
```

–û—Ç–∫—Ä–æ–π—Ç–µ: http://127.0.0.1:8000/toy

> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: Dockerfile —Å–æ–±–∏—Ä–∞–µ—Ç **CPU-–≤–µ—Ä—Å–∏—é** (–±–µ–∑ CUDA).

---

## üß™ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

### Health
```
GET /health
‚Üí {"status":"ok"}
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å
```
POST /v1/predict?output=both
Content-Type: multipart/form-data
Form field: image=@<file>
```

**–ü—Ä–∏–º–µ—Ä (curl):**
```bash
curl -X POST "http://127.0.0.1:8000/v1/predict?output=both"   -H "accept: application/json"   -H "Content-Type: multipart/form-data"   -F "image=@test.jpg"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "request_id": "ce0ab476",
  "outputs": [
    "artifacts/ce0ab476_mask.png",
    "artifacts/ce0ab476_overlay.png"
  ],
  "classes": ["soil","bedrock","sand","big_rock"]
}
```

–§–∞–π–ª—ã –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑:
```
GET /v1/file?path=artifacts/<–∏–º—è_—Ñ–∞–π–ª–∞>.png
```

### Toy-—Å—Ç—Ä–∞–Ω–∏—Ü–∞
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä—è–º–æ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ: **–û—Ä–∏–≥–∏–Ω–∞–ª**, **–ú–∞—Å–∫–∞**, **–û–≤–µ—Ä–ª–µ–π**.
- –ù–∏–∂–µ ‚Äî **–ª–µ–≥–µ–Ω–¥–∞** —Ü–≤–µ—Ç–æ–≤ –∫–ª–∞—Å—Å–æ–≤.
- –ü—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—à–ª—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è.

---

## üé® –õ–µ–≥–µ–Ω–¥–∞ –∫–ª–∞—Å—Å–æ–≤

| –ö–ª–∞—Å—Å      | –¶–≤–µ—Ç    |
|------------|---------|
| Soil       | üü• –∫—Ä–∞—Å–Ω—ã–π |
| Bedrock    | üü© –∑–µ–ª—ë–Ω—ã–π |
| Sand       | üü® –∂—ë–ª—Ç—ã–π  |
| Big Rock   | üü™ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π |

---

## üìå –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ** –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –æ—à–∏–±–æ—á–Ω–æ –ø–æ–º–µ—á–∞—Ç—å **—á–∞—Å—Ç–∏ –º–∞—Ä—Å–æ—Ö–æ–¥–∞** –∏–ª–∏ **–Ω–µ–±–æ** –∫–∞–∫ `Soil` –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏ –≤ –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö AI4Mars.
- –ù–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—é—Ç—Å—è RGB-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è; –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è resize 256√ó256, CLAHE –∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞/—è—Ä–∫–æ—Å—Ç–∏.

---

## üõ†Ô∏è Troubleshooting

- **`Model weights not found`** ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `models/deeplabv3.pth` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ `MARSSEG_WEIGHTS_URL`.
- **–ü—É—Å—Ç—ã–µ/—Å—Ç—Ä–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è** ‚Üí —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –Ω–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω —Å –æ–±—É—á–µ–Ω–∏–µ–º (CLAHE, alpha/beta, —Ä–∞–∑–º–µ—Ä 256).
- **Docker –±–∏–ª–¥ –¥–æ–ª–≥–∏–π** ‚Üí –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–±–æ—Ä–∫–∏ –±—ã—Å—Ç—Ä—ã–µ –∑–∞ —Å—á—ë—Ç –∫—ç—à–∞; –Ω–µ –º–µ–Ω—è–π—Ç–µ `requirements.txt` –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- **Windows + Docker** ‚Üí –ø—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–µ –ø–∞–ø–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `${PWD}` (PowerShell) –∏–ª–∏ `%cd%` (cmd).

---

## üìö –°—Ç–µ–∫

**Python**, **FastAPI**, **Uvicorn**, **PyTorch**, **Torchvision**, **OpenCV (headless)**, **Pydantic v2**, **Docker**.

---

## üîÆ –î–∞–ª—å–Ω–µ–π—à–∏–µ –ø–ª–∞–Ω—ã

- CI/CD (GitHub Actions): –±–∏–ª–¥ –æ–±—Ä–∞–∑–∞, smoke-—Ç–µ—Å—Ç `/health`.
- –ü–∞–∫–µ—Ç–Ω—ã–π –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫.
- –≠–∫—Å–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ –≤ ONNX/TorchScript –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.